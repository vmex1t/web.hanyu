---
---

<section class="cta-section" id="cta">
  <div class="cta-bg" aria-hidden="true"></div>
  <div class="container cta-inner reveal">
    <h2>Ready to start your<br/>Chinese journey?</h2>
    <p class="cta-sub">Join the TestFlight waitlist and be among the first to try Hanyu.</p>

    <form id="waitlist-form" class="waitlist-form" novalidate>
      <!-- Honeypot -->
      <div class="hp-field" aria-hidden="true">
        <label for="website">Website</label>
        <input type="text" id="website" name="website" tabindex="-1" autocomplete="off" />
      </div>

      <div class="form-group">
        <label for="wl-name">Name</label>
        <input type="text" id="wl-name" name="name" required placeholder="Your name" autocomplete="name" />
      </div>

      <fieldset class="form-group">
        <legend>Devices</legend>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" name="device" value="iPhone" />
            <span class="checkbox-custom"></span>
            iPhone
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="device" value="iPad" />
            <span class="checkbox-custom"></span>
            iPad
          </label>
        </div>
      </fieldset>

      <div class="form-group">
        <label for="wl-email">Apple&nbsp;ID Email</label>
        <input type="email" id="wl-email" name="email" required placeholder="you@example.com" autocomplete="email" />
      </div>

      <button type="submit" class="btn btn-primary cta-btn" id="wl-submit">
        <span class="btn-text">Join the Waitlist</span>
        <span class="btn-spinner" aria-hidden="true"></span>
      </button>
    </form>

    <div id="wl-success" class="wl-message wl-success" hidden>
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" aria-hidden="true">
        <circle cx="24" cy="24" r="24" fill="rgba(52,199,89,0.15)"/>
        <path d="M15 25l6 6 12-12" stroke="#34C759" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h3>You're on the list!</h3>
      <p>We'll send you a TestFlight invite soon.</p>
    </div>

    <div id="wl-error" class="wl-message wl-error" hidden>
      <p>Something went wrong. Please try again or email us at
        <a href="mailto:support@hanyu.app">support@hanyu.app</a>.
      </p>
    </div>
  </div>
</section>

<script>
  const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSewqSjO3dpsjJV6IYTuF7sM8g0NHpPu-SUkWzRa4TDCr63qyA/formResponse';

  const form = document.getElementById('waitlist-form') as HTMLFormElement;
  const submitBtn = document.getElementById('wl-submit') as HTMLButtonElement;
  const successEl = document.getElementById('wl-success')!;
  const errorEl = document.getElementById('wl-error')!;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Honeypot check
    const hp = (form.querySelector('[name="website"]') as HTMLInputElement).value;
    if (hp.trim() !== '') {
      // Silently pretend success
      successEl.hidden = false;
      setTimeout(() => { successEl.hidden = true; }, 5000);
      return;
    }

    const name = (form.querySelector('[name="name"]') as HTMLInputElement).value.trim();
    const email = (form.querySelector('[name="email"]') as HTMLInputElement).value.trim();
    const deviceBoxes = form.querySelectorAll<HTMLInputElement>('[name="device"]:checked');
    const devices = Array.from(deviceBoxes).map(cb => cb.value).join(', ');

    // Client-side validation
    if (!name || !email || !devices) {
      if (!devices) {
        const fieldset = form.querySelector('fieldset')!;
        fieldset.classList.add('field-error');
        fieldset.addEventListener('change', () => fieldset.classList.remove('field-error'), { once: true });
      }
      // Trigger native validation for text inputs
      form.reportValidity();
      return;
    }

    // Loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    errorEl.hidden = true;

    try {
      await fetch(FORM_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: new URLSearchParams({
          'entry.1998589119': name,
          'entry.275173679': devices,
          'entry.575647723': email,
        }),
      });
    } catch {
      // no-cors responses are opaque â€” errors are expected, ignore them
    } finally {
      // Always show success since we can't read the response with no-cors
      form.reset();
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      successEl.hidden = false;
      setTimeout(() => { successEl.hidden = true; }, 5000);
    }
  });
</script>

<style>
  .cta-section {
    position: relative;
    padding-block: clamp(80px, 10vw, 120px);
    text-align: center;
    overflow: hidden;
    background-color: var(--color-text);
    color: #fff;
  }

  .cta-bg {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse 70% 60% at 50% 100%, rgba(0, 97, 255, 0.2) 0%, transparent 100%);
    pointer-events: none;
  }

  .cta-inner {
    position: relative;
    max-width: 480px;
  }

  .cta-section h2 {
    margin-bottom: 16px;
    color: #fff;
  }

  .cta-sub {
    color: rgba(255, 255, 255, 0.65);
    font-size: var(--size-body-lg);
    margin-bottom: 40px;
  }

  /* ---- Form ---- */
  .waitlist-form {
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .hp-field {
    position: absolute;
    left: -9999px;
    opacity: 0;
    height: 0;
    overflow: hidden;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    border: none;
    padding: 0;
    margin: 0;
  }

  .form-group label,
  .form-group legend {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.7);
  }

  .form-group input[type="text"],
  .form-group input[type="email"] {
    padding: 12px 14px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.15s ease, background-color 0.15s ease;
  }

  .form-group input[type="text"]::placeholder,
  .form-group input[type="email"]::placeholder {
    color: rgba(255, 255, 255, 0.3);
  }

  .form-group input[type="text"]:focus,
  .form-group input[type="email"]:focus {
    outline: none;
    border-color: var(--color-primary);
    background: rgba(255, 255, 255, 0.12);
  }

  .form-group input:invalid:not(:placeholder-shown) {
    border-color: #FF453A;
  }

  .field-error {
    animation: shake 0.35s ease;
  }

  .field-error .checkbox-custom {
    border-color: #FF453A;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
  }

  /* ---- Checkboxes ---- */
  .checkbox-group {
    display: flex;
    gap: 24px;
    margin-top: 4px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9375rem;
    color: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    user-select: none;
  }

  .checkbox-label input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .checkbox-custom {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.06);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.15s ease, border-color 0.15s ease;
    flex-shrink: 0;
  }

  .checkbox-label input:checked + .checkbox-custom {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
  }

  .checkbox-label input:checked + .checkbox-custom::after {
    content: '';
    display: block;
    width: 6px;
    height: 10px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg) translateY(-1px);
  }

  .checkbox-label input:focus-visible + .checkbox-custom {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* ---- Submit Button ---- */
  .cta-btn {
    width: 100%;
    padding: 16px 40px;
    font-size: 1.0625rem;
    margin-top: 4px;
    position: relative;
  }

  .cta-btn.loading .btn-text {
    visibility: hidden;
  }

  .btn-spinner {
    display: none;
  }

  .cta-btn.loading .btn-spinner {
    display: block;
    position: absolute;
    width: 20px;
    height: 20px;
    border: 2.5px solid rgba(255, 255, 255, 0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .cta-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* ---- Success / Error ---- */
  .wl-message[hidden] {
    display: none;
  }

  .wl-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 20px;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .wl-success h3 {
    color: #fff;
    font-size: 1.5rem;
  }

  .wl-success p {
    color: rgba(255, 255, 255, 0.65);
  }

  .wl-error p {
    color: #FF453A;
    font-size: 0.9375rem;
  }

  .wl-error a {
    color: #FF453A;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .wl-error a:hover {
    color: #ff6961;
  }
</style>
